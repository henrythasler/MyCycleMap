

var _MAX_POINT_INTERVAL_MS=15e3;var _SECOND_IN_MILLIS=1e3;var _MINUTE_IN_MILLIS=60*_SECOND_IN_MILLIS;var _HOUR_IN_MILLIS=60*_MINUTE_IN_MILLIS;var _DEFAULT_MARKER_OPTS={startIconUrl:"pin-icon-start.png",endIconUrl:"pin-icon-end.png",shadowUrl:"pin-shadow.png",iconSize:[33,50],shadowSize:[50,50],iconAnchor:[16,45],shadowAnchor:[16,47]};var _DEFAULT_POLYLINE_OPTS={color:"blue"};L.GPX=L.FeatureGroup.extend({initialize:function(e,t){t.max_point_interval=t.max_point_interval||_MAX_POINT_INTERVAL_MS;t.marker_options=this._merge_objs(_DEFAULT_MARKER_OPTS,t.marker_options||{});t.polyline_options=this._merge_objs(_DEFAULT_POLYLINE_OPTS,t.polyline_options||{});L.Util.setOptions(this,t);L.GPXTrackIcon=L.Icon.extend({options:t.marker_options});this._gpx=e;this._layers={};this._info={name:null,length:0,elevation:{gain:0,loss:0,_points:[]},hr:{avg:0,_total:0,_points:[]},duration:{start:null,end:null,moving:0,total:0}};if(e){this._parse(e,t,this.options.async)}},get_duration_string:function(e,t){var n="";if(e>=_HOUR_IN_MILLIS){n+=Math.floor(e/_HOUR_IN_MILLIS)+":";e=e%_HOUR_IN_MILLIS}var r=Math.floor(e/_MINUTE_IN_MILLIS);e=e%_MINUTE_IN_MILLIS;if(r<10)n+="0";n+=r+"'";var i=Math.floor(e/_SECOND_IN_MILLIS);e=e%_SECOND_IN_MILLIS;if(i<10)n+="0";n+=i;if(!t&&e>0)n+="."+Math.round(Math.floor(e)*1e3)/1e3;else n+='"';return n},to_miles:function(e){return e/1.60934},to_ft:function(e){return e*3.28084},m_to_km:function(e){return e/1e3},m_to_mi:function(e){return e/1609.34},get_name:function(){return this._info.name},get_desc:function(){return this._info.desc},get_author:function(){return this._info.author},get_copyright:function(){return this._info.copyright},get_desc:function(){return this._info.desc},get_distance:function(){return this._info.length},get_start_time:function(){return this._info.duration.start},get_end_time:function(){return this._info.duration.end},get_moving_time:function(){return this._info.duration.moving},get_total_time:function(){return this._info.duration.total},get_moving_pace:function(){return this.get_moving_time()/this.m_to_km(this.get_distance())},get_moving_speed:function(){return this.m_to_km(this.get_distance())/(this.get_moving_time()/(3600*1e3))},get_elevation_gain:function(){return this._info.elevation.gain},get_elevation_loss:function(){return this._info.elevation.loss},get_elevation_data:function(){var e=this;return this._info.elevation._points.map(function(t){return e._prepare_data_point(t,e.m_to_km,null,function(e,t){return e.toFixed(2)+" km, "+t.toFixed(0)+" m"})})},get_average_hr:function(){return this._info.hr.avg},get_heartrate_data:function(){var e=this;return this._info.hr._points.map(function(t){return e._prepare_data_point(t,e.m_to_km,null,function(e,t){return e.toFixed(2)+" km, "+t.toFixed(0)+" bpm"})})},reload:function(){this.clearLayers();this._parse(this._gpx,this.options,this.options.async)},load:function(e){this._gpx=e;if(this._gpx){this._info={name:null,length:0,elevation:{gain:0,loss:0,_points:[]},hr:{avg:0,_total:0,_points:[]},duration:{start:null,end:null,moving:0,total:0}};this._parse(this._gpx,this.options,this.options.async)}},_merge_objs:function(e,t){var n={};for(var r in e){n[r]=e[r]}for(var r in t){n[r]=t[r]}return n},_prepare_data_point:function(e,t,n,r){var i=[t&&t(e[0])||e[0],n&&n(e[1])||e[1]];i.push(r&&r(i[0],i[1])||i[0]+": "+i[1]);return i},_load_xml:function(e,t,n,r){if(r==undefined)r=this.options.async;if(n==undefined)n=this.options;var i=new window.XMLHttpRequest;i.open("GET",e,r);try{i.overrideMimeType("text/xml")}catch(s){}i.onreadystatechange=function(){if(i.readyState!=4)return;if(i.status==200)t(i.responseXML,n)};i.send(null)},_textToXml:function(e){var t,n;if(window.DOMParser){try{n=new DOMParser;t=n.parseFromString(e,"text/xml")}catch(r){alert("XML parsing error.");return false}}else{t=new ActiveXObject("Microsoft.XMLDOM");t.async="false";t.loadXML(e)}return t},_parse:function(e,t,n){var r=this;var i=function(e,t){var n=r._parse_gpx_data(e,t);if(!n)return;r.addLayer(n);r.fire("loaded")};if(e.substr(0,1)==="<"){var s=new DOMParser;var o=r._textToXml(e,"text/xml");i(o,t)}else{this._load_xml(e,i,t,n)}},_parse_gpx_data:function(e,t){var n,r,i,s=[];var o=[["rte","rtept"],["trkseg","trkpt"]];var u=e.getElementsByTagName("name");if(u.length>0){this._info.name=u[0].textContent}var a=e.getElementsByTagName("desc");if(a.length>0){this._info.desc=a[0].textContent}var f=e.getElementsByTagName("author");if(f.length>0){this._info.author=f[0].textContent}var l=e.getElementsByTagName("copyright");if(l.length>0){this._info.copyright=l[0].textContent}for(n=0;n<o.length;n++){i=e.getElementsByTagName(o[n][0]);for(r=0;r<i.length;r++){var c=this._parse_trkseg(i[r],e,t,o[n][1]);if(c.length===0)continue;if(n==0){this.fire("addroute",{c:c});continue}else var h=new L.Polyline(c,t.polyline_options);this.fire("addline",{line:h});s.push(h);if(t.marker_options.startIconUrl){var p=new L.Marker(c[0],{clickable:false,icon:new L.GPXTrackIcon({iconUrl:t.marker_options.startIconUrl})});this.fire("addpoint",{point:p});s.push(p)}if(t.marker_options.endIconUrl){p=new L.Marker(c[c.length-1],{clickable:false,icon:new L.GPXTrackIcon({iconUrl:t.marker_options.endIconUrl})});this.fire("addpoint",{point:p});s.push(p)}}}this._info.hr.avg=Math.round(this._info.hr._total/this._info.hr._points.length);if(!s.length)return;var d=s[0];if(s.length>1)d=new L.FeatureGroup(s);return d},_parse_trkseg:function(e,t,n,r){var i=e.getElementsByTagName(r);if(!i.length)return[];var s=[];var o=null;for(var u=0;u<i.length;u++){var a,f=new L.LatLng(i[u].getAttribute("lat"),i[u].getAttribute("lon"));f.meta={time:null,ele:null,hr:null};a=i[u].getElementsByTagName("time");if(a.length>0){f.meta.time=new Date(Date.parse(a[0].textContent))}a=i[u].getElementsByTagName("ele");if(a.length>0){f.meta.ele=parseFloat(a[0].textContent)}a=i[u].getElementsByTagNameNS("*","hr");if(a.length>0){f.meta.hr=parseInt(a[0].textContent);this._info.hr._points.push([this._info.length,f.meta.hr]);this._info.hr._total+=f.meta.hr}this._info.elevation._points.push([this._info.length,f.meta.ele]);this._info.duration.end=f.meta.time;if(o!=null){this._info.length+=this._dist3d(o,f);var l=f.meta.ele-o.meta.ele;if(l>0)this._info.elevation.gain+=l;else this._info.elevation.loss+=Math.abs(l);l=Math.abs(f.meta.time-o.meta.time);this._info.duration.total+=l;if(l<n.max_point_interval)this._info.duration.moving+=l}else{this._info.duration.start=f.meta.time}o=f;s.push(f)}return s},_dist2d:function(e,t){var n=6371e3;var r=this._deg2rad(t.lat-e.lat);var i=this._deg2rad(t.lng-e.lng);var s=Math.sin(r/2)*Math.sin(r/2)+Math.cos(this._deg2rad(e.lat))*Math.cos(this._deg2rad(t.lat))*Math.sin(i/2)*Math.sin(i/2);var o=2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s));var u=n*o;return u},_dist3d:function(e,t){var n=this._dist2d(e,t);var r=Math.abs(t.meta.ele-e.meta.ele);return Math.sqrt(Math.pow(n,2)+Math.pow(r,2))},_deg2rad:function(e){return e*Math.PI/180}})